<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <script type="text/javascript" src="https://threejs.org/examples/js/libs/stats.min.js"></script>

    <style type="text/css">
        body {
            display: flex;
            justify-content: center;
            background: white;
        }
        #tag {
            background: #111;
            width: 50vmin;
            height: 50vmin;
            border: 13vmin;
            border-style: solid;
            border-color: black;
            margin: 75px;
        }
        #log {
            position: absolute;
            top: 10px;
            right: 25px;
        }
    </style>

    <title>Web GLITTER tag</title>
</head>
<body>
    <div id="stats"></div>
    <div id="log">Average Timer Error: 0 ms</div>
    <div id="tag"></div>

    <script type="text/javascript">
        const stats = new Stats();
        stats.showPanel(0);
        document.getElementById("stats").appendChild(stats.domElement);

        const tag = document.getElementById("tag");
        const log = document.getElementById("log");

        function dec2bin(dec) {
            return (dec >>> 0).toString(2);
        }

        function getUrlVars() {
            const vars = {};
            const parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
                vars[key] = value;
            });
            return vars;
        }

        function getUrlParam(parameter, defaultValue) {
            let urlParameter = defaultValue;
            if (window.location.href.indexOf(parameter) > -1) {
                urlParameter = getUrlVars()[parameter];
            }
            if (urlParameter === "") {
                return defaultValue;
            }
            return urlParameter;
        }

        function preprocess(code) {
            let res = 0;
            for (let i = 0; i < 8; i++) {
                const currBit = !!(code & (1 << (8-i-1)));
                const nextIdx = (i + 1) % 8;
                const nextBit = !!(code & (1 << (8-nextIdx-1)));

                res |= (currBit << (16-2*i-1));

                if (currBit != nextBit) {
                    if (currBit == 1) {
                        res |= (0 << (16-2*i-2));
                    }
                    // else if (currBit == 0) {
                    //     res |= (1 << (16-2*i-2));
                    // }
                }
                else {
                    res |= (currBit << (16-2*i-2));
                }
            }
            return res;
        }

        const freq = getUrlParam("freq") ? parseInt(getUrlParam("freq")) : 30;
        const interval = 1000 / freq; // ms

        const len = 16;
        let code = getUrlParam("code") ? parseInt(getUrlParam("code")) : 0xaf;
        code = preprocess(code);

        let running = false;
        let blink;
        let totalDt = 0; let iters = 0;
        window.onmouseup = window.ontouchend = function() {
            if (!running) {
                let idx = 0;
                let expected = Date.now() + interval;
                setTimeout(tick, interval);
                function tick() {
                    if (!running) return;
                    const dt = Date.now() - expected;
                    if (dt > interval) { // adjust for errors
                        expected += interval * Math.floor(dt / interval);
                    }
                    const startCompute = Date.now();
                    totalDt += Math.abs(dt); iters++;
                    log.innerHTML = `Average Timer Error: ${(totalDt/iters).toFixed(2)} ms`;

                    const bit = Number(!!(code & (1 << (len-idx-1))));
                    if (bit == 1) {
                        tag.style.background = "white"
                    }
                    else {
                        tag.style.background = "#111"
                    }
                    idx = (idx+1) % len;
                    stats.update();

                    expected += interval;
                    const computationTime = Date.now() - startCompute;
                    setTimeout(tick, Math.max(0, interval - dt - computationTime)); // take into account drift
                }
            }
            else {
                tag.style.background = "#111"
            }
            running = !running;
        }
    </script>
</body>
</html>
